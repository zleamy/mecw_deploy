<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marx/Engels Archive LLM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Times New Roman", serif;
      background-color: #1f1f2e;
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .search-form {
      background-color: #2c2c3c;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .search-input {
      width: 100%;
      height: 100px;
      background-color: #1f1f2e;
      color: #f5f5f5;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      font-size: 16px;
      resize: vertical;
      margin-bottom: 15px;
    }
    
    .search-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-btn {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .search-btn:hover {
      background-color: #5ba0f2;
    }
    
    .search-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    
    .citation-select {
      background-color: #1f1f2e;
      color: #f5f5f5;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 8px;
    }
    
    .status {
      margin-top: 10px;
      font-style: italic;
    }
    
    .status.error {
      color: #ff6b6b;
    }
    
    .status.success {
      color: #51cf66;
    }
    
    .results {
      background-color: #2c2c3c;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
    }
    
    .answer-section {
      background-color: #1f1f2e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #4a90e2;
    }
    
    .answer-text {
      white-space: pre-wrap;
      line-height: 1.6;
    }
    
    .docs-section {
      margin-top: 30px;
    }
    
    .doc-item {
      background-color: #1f1f2e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #666;
    }
    
    .doc-meta {
      color: #b8b8b8;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .doc-text {
      white-space: pre-wrap;
      line-height: 1.5;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      color: #4a90e2;
    }
    
    .spinner {
      border: 4px solid #444;
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Marx/Engels Collected Works Archive</h1>
      <p>Search and analyze the complete MECW collection with AI assistance</p>
    </div>
    
    <div class="search-form">
      <textarea 
        id="queryInput" 
        class="search-input" 
        placeholder="Enter your search query about Marx and Engels' works..."
      ></textarea>
      
      <div class="search-controls">
        <button id="searchBtn" class="search-btn">Search Archive</button>
        
        <label for="citationStyle">Citation Style:</label>
        <select id="citationStyle" class="citation-select">
          <option value="Chicago">Chicago</option>
          <option value="APA">APA</option>
          <option value="MLA">MLA</option>
        </select>
      </div>
      
      <div id="status" class="status"></div>
    </div>
    
    <div id="results"></div>
  </div>

  <script>
    const BACKEND_URL = "http://localhost:8000/query";
    
    const queryInput = document.getElementById('queryInput');
    const searchBtn = document.getElementById('searchBtn');
    const citationStyle = document.getElementById('citationStyle');
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    
    function showStatus(message, type = '') {
      status.textContent = message;
      status.className = `status ${type}`;
    }
    
    function showLoading() {
      results.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Searching MECW archive and generating analysis...</p>
          <p>This may take 30-60 seconds</p>
        </div>
      `;
    }
    
    function showError(message) {
      results.innerHTML = `
        <div class="results">
          <h3 style="color: #ff6b6b;">Search Error</h3>
          <p>${message}</p>
          <p>Please check that your backend is running and try again.</p>
        </div>
      `;
    }
    
    function extractDocumentTitle(text) {
      if (!text) return "Untitled Document";
      
      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      
      // Look for common MECW title patterns
      for (let i = 0; i < Math.min(8, lines.length); i++) {
        const line = lines[i];
        
        // Skip very short lines
        if (line.length < 15) continue;
        
        // Look for ALL CAPS titles (common in MECW)
        if (line === line.toUpperCase() && line.length > 20 && line.length < 120) {
          return line;
        }
        
        // Look for title case with specific patterns
        if (line.match(/^[A-Z][a-zA-Z\s]+[A-Z][a-zA-Z\s]*/) && 
            line.length > 20 && line.length < 120 && 
            !line.includes('Marx') && !line.includes('Engels')) {
          return line;
        }
        
        // Look for lines that start with quotes or specific formatting
        if ((line.startsWith('"') || line.match(/^[A-Z][a-z]+\s+[A-Z]/)) && 
            line.length > 25 && line.length < 100) {
          return line;
        }
      }
      
      // Fallback: use first substantial line, truncated if needed
      for (const line of lines) {
        if (line.length > 30) {
          return line.length > 80 ? line.substring(0, 77) + "..." : line;
        }
      }
      
      return "Document Fragment";
    }
    
    function displayResults(data) {
      let html = '<div class="results">';
      
      // Show the main answer
      if (data.answer) {
        html += `
          <div class="answer-section">
            <h3>Analysis</h3>
            <div class="answer-text">${data.answer}</div>
          </div>
        `;
      }
      
      // Show retrieved documents
      if (data.retrieved_docs && data.retrieved_docs.length > 0) {
        html += `
          <div class="docs-section">
            <h3>Source Documents (${data.retrieved_docs.length})</h3>
        `;
        
        data.retrieved_docs.forEach((doc, index) => {
          const docTitle = extractDocumentTitle(doc.text);
          const volumeBadge = `<span style="background: #2c5282; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">Vol. ${doc.volume}</span>`;
          const relevanceBadge = `<span style="background: #4a90e2; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">Relevance: ${doc.score.toFixed(3)}</span>`;
          
          html += `
            <div class="doc-item">
              <div class="doc-title">${docTitle}</div>
              <div class="doc-meta">
                ${volumeBadge}
                <span>Chunk ${doc.chunk_id}</span>
                <span>Page ${doc.page}</span>
                ${relevanceBadge}
              </div>
              <div class="doc-text">${doc.text}</div>
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      html += '</div>';
      results.innerHTML = html;
    }
    
    async function performSearch() {
      const query = queryInput.value.trim();
      
      if (!query) {
        showStatus('Please enter a search query', 'error');
        return;
      }
      
      searchBtn.disabled = true;
      showStatus('Searching...', '');
      showLoading();
      
      try {
        console.log('Sending request to:', BACKEND_URL);
        console.log('Query:', query);
        
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query: query,
            citation_style: citationStyle.value
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        displayResults(data);
        showStatus('Search completed successfully', 'success');
        
      } catch (error) {
        console.error('Search error:', error);
        showError(error.message);
        showStatus(`Search failed: ${error.message}`, 'error');
      } finally {
        searchBtn.disabled = false;
      }
    }
    
    // Event listeners
    searchBtn.addEventListener('click', performSearch);
    
    queryInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        performSearch();
      }
    });
    
    // Initial status
    showStatus('Ready to search the MECW archive');
    queryInput.focus();
  </script>
</body>
</html>